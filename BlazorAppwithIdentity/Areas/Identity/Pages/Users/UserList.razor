@page "/user"
@using Microsoft.AspNetCore.Identity;
@using Microsoft.EntityFrameworkCore;
@using System.Security.Claims;

@inject UserManager<ApplicationUser> _userManager
@inject AuthenticationStateProvider _authenticationStateProvider
@inject IJSRuntime _jsRuntime

<_DeleteConfirmation ConfirmationChanged="ConfirmDeleteClickAsync"></_DeleteConfirmation>

<div class="row mt-4">
    <div class="col-6">
        <h4 class="card-title text-black">Users List</h4>
    </div>
    <div class="col-4 offset-2">
        <a href="user/create" class="btn btn-primary form-control">Add New User</a>
    </div>
    <div class="col-12">
        @if (users.Any())
        {
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Adress</th>
                        <th>Phone Number</th>
                        <th>Initial Property Value Sum</th>
                        <th>Current Property Value Sum</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in users)
                    {
                        <tr>
                            <td>
                                @item.Name
                            </td>
                            <td>
                                @item.Email
                            </td>
                            <td>
                                @item.Address
                            </td>
                            <td>
                                @item.PhoneNumber
                            </td>
                            <td>
                                @item.InitialPropertyValueSum
                            </td>
                            <td>
                                @item.CurrentPropertyValueSum
                            </td>
                            <td>
                                <NavLink href="@($"user/edit/{item.Id}")" class="btn-primary btn">Edit</NavLink>
                                <button class="btn btn-danger" @onclick="async () => await HandleDelete(item.Id)">Delete</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>


@code {
    private IEnumerable<UserVM> users { get; set; } = new List<UserVM>();
    private string? DeleteUserId { get; set; } = null;
    protected override async Task OnInitializedAsync()
    {
        var authenticationState = await _authenticationStateProvider.GetAuthenticationStateAsync();
        var user = authenticationState.User;
        var usersAll = await _userManager.Users.ToListAsync();
        users = usersAll.Select(p => new UserVM
        {
                Id = p.Id,
                Name = p.Name,
                Email = p.Email,
                Address = p.Address,
                PhoneNumber = p.PhoneNumber,
                InitialPropertyValueSum = p.InitialPropertyValueSum.GetValueOrDefault(),
                CurrentPropertyValueSum = p.CurrentPropertyValueSum.GetValueOrDefault()
            }).Where(p => p.Id != user.FindFirst(ClaimTypes.NameIdentifier)?.Value);
    }

    private async Task HandleDelete(string id)
    {
        DeleteUserId = id; 
        await _jsRuntime.InvokeVoidAsync("ShowDeleteConfirmationModal");
    }

    private async Task ConfirmDeleteClickAsync(bool isConfirmed)
    {
        if (isConfirmed && DeleteUserId != null)
        {
            var existingUser = await _userManager.FindByIdAsync(DeleteUserId);
            await _userManager.DeleteAsync(existingUser);
            users = users.Where(x => x.Id != DeleteUserId);
            await _jsRuntime.InvokeVoidAsync("HideDeleteConfirmationModal");
        }
    }
}

